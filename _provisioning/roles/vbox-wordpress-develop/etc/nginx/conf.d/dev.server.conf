upstream phpfpm {
    server  unix:/var/run/php-fpm.sock;
}

server {
    listen      80 default;
    server_name _;
    return 301 https://$host$request_uri;
}

server {
    listen      443 default ssl;
    server_name _;

    root        /var/www/vhosts/wordpress;
    index       index.html index.htm index.php;
    charset     utf-8;

#   access_log  /var/log/nginx/ap.access.log  main;
    access_log  /var/log/nginx/ap.access.log  ltsv;
    error_log   /var/log/nginx/ap.error.log   error;

    # ssl
    ssl                        on;
    ssl_certificate            /etc/nginx/ssl/server.crt;
    ssl_certificate_key        /etc/nginx/ssl/server.nokey;
   #ssl_certificate_key        /etc/nginx/ssl/server.key;
    ssl_ciphers                'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA:!aNULL';
    ssl_prefer_server_ciphers  on;
    ssl_protocols              SSLv2 SSLv3 TLSv1;
    ssl_session_cache          shared:SSL:10m;
    ssl_session_timeout        10m;

    # acl
#   include /etc/nginx/include/acl;

    # maint
    set $go_maint  0;
    include /etc/nginx/include/maint;

    # useragent
    set $is_mobile 0;
    include /etc/nginx/include/useragent;

    # drop
    include /etc/nginx/include/drop;

    set $mobile '';
#   include /etc/nginx/include/mobile-detect;

    # worpress
#   include /etc/nginx/wp-multisite-subdir;
    include /etc/nginx/wp-singlesite;

    location / {
        if ($go_maint = 1) {
            return  503;
        }

        location /login {
            return  301  /wp-login.php;
        }

        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
#       limit_req zone=method;

        if ($go_maint = 1) {
            return  503;
        }
        if (!-f $request_filename) {
            return 404;
        }

#       location ~ ^/wp-(config|links-opml|settings|trackback).php {
#           return 404;
#       }

#       location ~ ^/xmlrpc.php {
#           return 404;
#       }

#       location ~ ^/wp-admin/install.php {
#           return 404;
#       }

        location ~ ^/wp-(login|signup).php {
#           include /etc/nginx/include/acl;

            if ($go_maint = 1) {
                return  503;
            }

            # fastcgi
            include /etc/nginx/fastcgi;

            # fastcgi cache
#           include /etc/nginx/fastcgi_cache;
        }

        location ~ ^/wp-admin/admin-ajax.php {
            access_log  off;

            # fastcgi
            include /etc/nginx/fastcgi;
        }

        # fastcgi
        include /etc/nginx/fastcgi;

        # fastcgi cache
#       include /etc/nginx/fastcgi_cache;

    }

    # common_assets
    include /etc/nginx/common_assets;

    # common_healthcheck
    include /etc/nginx/common_healthcheck;

    # common_fallbacks
    include /etc/nginx/common_fallbacks;

    # nginx_status
    include /etc/nginx/nginx_status;

    # phpfpm_status
    include /etc/nginx/phpfpm_status;

}
